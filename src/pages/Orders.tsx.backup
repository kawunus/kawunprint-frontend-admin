import React, { useEffect, useMemo, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useOrders } from '../hooks/useOrders';
import { Button } from '../components/ui/Button';
import { useTranslation } from 'react-i18next';
import { formatLocalDateTime, parseDbDate } from '../utils/datetime';
import { ordersApi } from '../api/orders';
import { StatusBadge } from '../components/orders/StatusBadge';

export const Orders: React.FC = () => {
  const navigate = useNavigate();
  const { orders, orderStatuses, loading, error, refreshOrders } = useOrders();
  const [statusFilter, setStatusFilter] = useState<'all' | number>('all');
  const [search, setSearch] = useState<string>('');
  const [sortBy, setSortBy] = useState<'date' | 'total' | 'status' | 'customer'>('date');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  const { t, i18n } = useTranslation();
  const isRu = i18n.language?.startsWith('ru');
  
  // Filter modal state
  const [showFilters, setShowFilters] = useState(false);

  const [modalStatus, setModalStatus] = useState<'all' | number>('all');
  const [modalDateFrom, setModalDateFrom] = useState<string>('');
  const [modalDateTo, setModalDateTo] = useState<string>('');
  const [modalMinTotal, setModalMinTotal] = useState<string>('');
  const [modalMaxTotal, setModalMaxTotal] = useState<string>('');
  const [modalCustomer, setModalCustomer] = useState<string>('');

  // Applied filters
  const [appliedDateFrom, setAppliedDateFrom] = useState<string>('');
  const [appliedDateTo, setAppliedDateTo] = useState<string>('');
  const [appliedMinTotal, setAppliedMinTotal] = useState<string>('');
  const [appliedMaxTotal, setAppliedMaxTotal] = useState<string>('');
  const [appliedCustomer, setAppliedCustomer] = useState<string>('');

  // Delete modal state
  const [deleteId, setDeleteId] = useState<number | null>(null);

  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        setShowFilters(false);
        setDeleteId(null);
      }
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, []);

  const statusNameById = useMemo(() => {
    const map = new Map<number, string>();
    orderStatuses.forEach(s => map.set(s.id, s.description));
    return (id?: number, fallback?: string) => (id != null ? map.get(id) : undefined) || fallback || '';
  }, [orderStatuses]);

  const filteredOrders = useMemo(() => {
    let list = orders;
    
    // Status filter
    if (statusFilter !== 'all') {
      list = list.filter(o => (o.statusId ?? -1) === statusFilter);
    }
    
    // Customer filter
    if (appliedCustomer.trim()) {
      const q = appliedCustomer.trim().toLowerCase();
      list = list.filter(o => {
        const name = `${o.customer.firstName || ''} ${o.customer.lastName || ''}`.toLowerCase();
        const email = (o.customer.email || '').toLowerCase();
        return name.includes(q) || email.includes(q);
      });
    }
    
    // Date filters
    if (appliedDateFrom) {
      const fromTs = new Date(appliedDateFrom).getTime();
      list = list.filter(o => (parseDbDate(o.createdAt)?.getTime() ?? 0) >= fromTs);
    }
    if (appliedDateTo) {
      const toTs = new Date(appliedDateTo).getTime();
      list = list.filter(o => (parseDbDate(o.createdAt)?.getTime() ?? 0) <= toTs);
    }
    
    // Price filters
    if (appliedMinTotal) {
      const min = Number(appliedMinTotal);
      if (!Number.isNaN(min)) list = list.filter(o => o.totalPrice >= min);
    }
    if (appliedMaxTotal) {
      const max = Number(appliedMaxTotal);
      if (!Number.isNaN(max)) list = list.filter(o => o.totalPrice <= max);
    }
    
    // Search
    if (search.trim()) {
      const q = search.trim().toLowerCase();
      list = list.filter(o => {
        const name = `${o.customer.firstName || ''} ${o.customer.lastName || ''}`.toLowerCase();
        const email = (o.customer.email || '').toLowerCase();
        const idMatch = String(o.id).includes(q);
        return name.includes(q) || email.includes(q) || idMatch;
      });
    }
    
    return list;
  }, [orders, statusFilter, appliedCustomer, appliedDateFrom, appliedDateTo, appliedMinTotal, appliedMaxTotal, search]);

  const sorted = useMemo(() => {
    const dir = sortOrder === 'asc' ? 1 : -1;
    return [...filteredOrders].sort((a, b) => {
      if (sortBy === 'date') {
        const ad = parseDbDate(a.createdAt)?.getTime() ?? 0;
        const bd = parseDbDate(b.createdAt)?.getTime() ?? 0;
        return (ad - bd) * dir;
      }
      if (sortBy === 'total') {
        return (a.totalPrice - b.totalPrice) * dir;
      }
      if (sortBy === 'status') {
        const nameA = statusNameById(a.statusId, a.status).toLowerCase();
        const nameB = statusNameById(b.statusId, b.status).toLowerCase();
        return nameA.localeCompare(nameB) * dir;
      }
      if (sortBy === 'customer') {
        const A = `${a.customer.firstName || ''} ${a.customer.lastName || ''}`.trim().toLowerCase();
        const B = `${b.customer.firstName || ''} ${b.customer.lastName || ''}`.trim().toLowerCase();
        return A.localeCompare(B) * dir;
      }
      return 0;
    });
  }, [filteredOrders, sortBy, sortOrder, statusNameById]);

  const handleDelete = async (id: number) => {
    try {
      await ordersApi.deleteOrder(id);
      setDeleteId(null);
      refreshOrders();
    } catch (err) {
      console.error('Failed to delete order:', err);
      alert(t('errors.deleteFailed') || 'Failed to delete order');
    }
  };

  const clearAllFilters = () => {
    setSearch('');
    setStatusFilter('all');
    setAppliedCustomer('');
    setAppliedDateFrom('');
    setAppliedDateTo('');
    setAppliedMinTotal('');
    setAppliedMaxTotal('');
  };

  const hasActiveFilters = search || statusFilter !== 'all' || appliedCustomer || appliedDateFrom || appliedDateTo || appliedMinTotal || appliedMaxTotal;

  if (error) {
    return (
      <div className="p-6">
        <div className="rounded-md bg-red-50 p-4">
          <div className="text-red-700">{error}</div>
          <Button onClick={refreshOrders} className="mt-2">
            {t('common.retry') || (isRu ? 'Повторить' : 'Retry')}
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold text-gray-900">{t('orders.title') || 'Orders'}</h1>
        <Button onClick={() => navigate('/orders/new')} variant="primary">
          {t('orders.new') || 'New order'}
        </Button>
      </div>

      {/* Toolbar */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex flex-wrap items-center gap-3">
          {/* Search */}
          <div className="relative flex-1 min-w-[200px]">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg className="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </div>
            <input
              type="text"
              placeholder={t('orders.searchPlaceholder') || (isRu ? 'Поиск заказа' : 'Search order')}
              value={search}
              onChange={e => setSearch(e.target.value)}
              className="w-full text-sm py-2 pl-9 pr-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Sort */}
          <div className="flex items-center gap-2">
            <select 
              className="border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={sortBy} 
              onChange={e => setSortBy(e.target.value as any)}
            >
              <option value="date">{t('orders.sortField.date') || 'Date'}</option>
              <option value="total">{t('orders.sortField.total') || 'Total'}</option>
              <option value="status">{t('orders.sortField.status') || 'Status'}</option>
              <option value="customer">{t('orders.sortField.customer') || 'Customer'}</option>
            </select>
            
            <button 
              className="px-3 py-2 text-sm border rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onClick={() => setSortOrder(s => s === 'asc' ? 'desc' : 'asc')}
            >
              {sortOrder === 'asc' 
                ? (isRu ? (t('filters.orderDisplayAsc') || 'А → Я') : (t('filters.orderDisplayAsc') || 'A → Z'))
                : (isRu ? (t('filters.orderDisplayDesc') || 'Я → А') : (t('filters.orderDisplayDesc') || 'Z → A'))
              }
            </button>
          </div>

          {/* Filters button */}
          <Button
            variant="secondary"
            size="sm"
            onClick={() => {
              if (!showFilters) {
                setModalStatus(statusFilter);
                setModalCustomer(appliedCustomer);
                setModalDateFrom(appliedDateFrom);
                setModalDateTo(appliedDateTo);
                setModalMinTotal(appliedMinTotal);
                setModalMaxTotal(appliedMaxTotal);
              }
              setShowFilters(s => !s);
            }}
          >
            {t('filters.open') || 'Filters'}
          </Button>

          {/* Clear filters */}
          {hasActiveFilters && (
            <Button variant="secondary" size="sm" onClick={clearAllFilters}>
              {t('filters.clear') || 'Clear'}
            </Button>
          )}

          {/* Refresh */}
          <Button onClick={refreshOrders} variant="secondary" size="sm">
            {t('common.refresh') || (isRu ? 'Обновить' : 'Refresh')}
          </Button>
        </div>
      </div>

      {/* Orders Table */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        {loading ? (
          <div className="flex justify-center items-center h-64">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
          </div>
        ) : sorted.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            {t('table.noData') || 'No data available'}
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    ID
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('orders.customer') || 'Customer'}
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('orders.sortField.status') || 'Status'}
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('orders.sortField.total') || 'Total'}
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('orders.created') || 'Created'}
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('common.actions') || 'Actions'}
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {sorted.map(order => {
                  const currentStatusName = statusNameById(order.statusId, order.status);
                  
                  return (
                    <tr key={order.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        #{order.id}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-gray-900">
                          {order.customer.firstName} {order.customer.lastName}
                        </div>
                        <div className="text-sm text-gray-500">{order.customer.email}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <StatusBadge status={currentStatusName} />
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {order.totalPrice.toFixed(2)} BYN
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {formatLocalDateTime(order.createdAt, i18n.language)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <Button
                          onClick={() => navigate(`/orders/${order.id}`)}
                          variant="secondary"
                          size="sm"
                        >
                          {t('common.details') || 'Details'}
                        </Button>
                        <Button
                          onClick={() => navigate(`/orders/${order.id}/edit`)}
                          variant="secondary"
                          size="sm"
                        >
                          {t('common.edit') || 'Edit'}
                        </Button>
                        <Button
                          onClick={() => setDeleteId(order.id)}
                          variant="danger"
                          size="sm"
                        >
                          {t('common.delete') || 'Delete'}
                        </Button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Filters Modal */}
      {showFilters && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black opacity-50" onClick={() => setShowFilters(false)} />
          <div className="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <h3 className="text-lg font-semibold mb-4">{t('filters.title') || 'Filters'}</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Status */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filters.status') || 'Status'}
                  </label>
                  <select
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalStatus === 'all' ? 'all' : String(modalStatus)}
                    onChange={(e) => setModalStatus(e.target.value === 'all' ? 'all' : Number(e.target.value))}
                  >
                    <option value="all">{t('orders.status.all') || 'All'}</option>
                    {orderStatuses.map(status => (
                      <option key={status.id} value={status.id}>{status.description}</option>
                    ))}
                  </select>
                </div>

                {/* Customer */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filter.customer') || 'Customer'}
                  </label>
                  <input
                    type="text"
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalCustomer}
                    onChange={(e) => setModalCustomer(e.target.value)}
                    placeholder={t('orders.filter.customerPlaceholder') || (isRu ? 'имя или email' : 'name or email')}
                  />
                </div>

                {/* Date from */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filter.dateFrom') || 'Date from'}
                  </label>
                  <input
                    type="date"
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalDateFrom}
                    onChange={(e) => setModalDateFrom(e.target.value)}
                  />
                </div>

                {/* Date to */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filter.dateTo') || 'Date to'}
                  </label>
                  <input
                    type="date"
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalDateTo}
                    onChange={(e) => setModalDateTo(e.target.value)}
                  />
                </div>

                {/* Min total */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filter.minTotal') || 'Min total'}
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalMinTotal}
                    onChange={(e) => setModalMinTotal(e.target.value)}
                    placeholder="0.00"
                  />
                </div>

                {/* Max total */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {t('orders.filter.maxTotal') || 'Max total'}
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={modalMaxTotal}
                    onChange={(e) => setModalMaxTotal(e.target.value)}
                    placeholder="0.00"
                  />
                </div>
              </div>

              <div className="mt-6 flex gap-2">
                <Button 
                  variant="primary" 
                  onClick={() => {
                    setStatusFilter(modalStatus);
                    setAppliedCustomer(modalCustomer);
                    setAppliedDateFrom(modalDateFrom);
                    setAppliedDateTo(modalDateTo);
                    setAppliedMinTotal(modalMinTotal);
                    setAppliedMaxTotal(modalMaxTotal);
                    setShowFilters(false);
                  }}
                >
                  {t('common.apply') || 'Apply'}
                </Button>
                <Button variant="secondary" onClick={() => setShowFilters(false)}>
                  {t('common.cancel') || 'Cancel'}
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {deleteId !== null && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black opacity-50" onClick={() => setDeleteId(null)} />
          <div className="bg-white rounded-lg shadow-xl z-50 w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
            <h3 className="text-lg font-semibold mb-4">{t('common.confirm') || 'Confirm'}</h3>
            <p className="text-gray-700 mb-6">
              {t('orders.confirmDelete', { id: deleteId }) || `Are you sure you want to delete order #${deleteId}?`}
            </p>
            <div className="flex gap-2">
              <Button variant="danger" onClick={() => handleDelete(deleteId)}>
                {t('common.delete') || 'Delete'}
              </Button>
              <Button variant="secondary" onClick={() => setDeleteId(null)}>
                {t('common.cancel') || 'Cancel'}
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};